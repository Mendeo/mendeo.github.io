<!DOCTYPE html>
<html lang="en">
	<head>
		{%- include head.html -%}
	</head>
	<body>
		<main class="container">
			<section class="about">
				<a href="{{ site.baseurl }}/"><img src="{{ site.mendeo.avatar }}" alt="{{ site.plainwhite.name }}"></a>
				<h2 id="title">
					<a href="{{ site.baseurl }}/">{{ site.plainwhite.name }}</a>
				</h2>
				<p class="tagline">{{ site.plainwhite.tagline }}</p>

				<ul class="social">
					{%- if site.plainwhite.social_links.github -%}
					<li>
						<a href="https://github.com/{{ site.plainwhite.social_links.github }}" target="_blank" class="icon-github-circled"></a>
					</li>
					{%- endif -%}
					{%- if site.plainwhite.social_links.vk -%}
					<li>
						<a href="https://vk.com/{{ site.plainwhite.social_links.vk }}" target="_blank" class="icon-vk"></a>
					</li>
					{%- endif -%}
					{%- if site.plainwhite.social_links.facebook -%}
					<li>
						<a href="https://facebook.com/{{ site.plainwhite.social_links.facebook }}" target="_blank" class="icon-facebook"></a>
					</li>
					{%- endif -%}
					{%- if site.plainwhite.social_links.instagram -%}
					<li>
						<a href="https://instagram.com/{{ site.plainwhite.social_links.instagram }}" target="_blank" class="icon-instagram"></a>
					</li>
					{%- endif -%}
				</ul>
				
				{%- if site.plainwhite.navigation -%}
					<nav class="navigation">
						<ul>
							{%- for link in site.plainwhite.navigation -%}
							<li>
								<a href="{{ link.url | relative_url }}">{{ link.title }}</a>
							</li>
							{%- endfor -%}
						</ul>
					</nav>
				{%- endif -%}

				<p>
					&copy;
					{{ "now" | date: "%Y" }}
					<a href = "{{ "/feed.xml" | relative_url }}" class="icon-rss" style="text-decoration: none"></a>
					<a href = "{{ "https://t.me/mendeo_blog" | relative_url }}" target="_blank" style="text-decoration: none">
						<img src="/assets/images/telegram.svg" style="vertical-align: text-bottom">
					</a>
				</p>
			</section>
			<section class="content">
				{{ content }}
			</section>
		</main>
		{%- if page.links_in_new_tab -%}
			<!-- Открываем ссылки в новом окне -->
			<script type="text/javascript">
				(function ()
				{
					'use strict';
					let links = document.querySelectorAll('.post a');
					links.forEach((link) => link.target = '_blank');
				})();
			</script>
		{%- endif -%}
		{%- if page.has_scalable_images -%}
		<!-- Мой скрипт для увеличения картинок (у img должен быть атрибут src-big с путём к большому изображению) -->
		<script type="text/javascript">
			(function()
			{
				'use strict';
				//Создаём полупрозрачный серый фон на заднем плане под увеличенным изображением.
				//Он будет перекрывать все элементы экрана.
				const imgBg = document.createElement('div');
				document.getElementsByTagName('body')[0].appendChild(imgBg);
				imgBg.style = 'background-color: rgba(48, 48, 48, 0.6); position: fixed; top: 0px; left: 0px; width: 100%; z-index: 1';
				imgBg.hidden = true;
				fillBg(); //Функция, которая растягивает серый фон по высоте на весь экран.
				//Перерисовываем высоту серого фона при изменении размеров окна браузера.
				window.addEventListener('resize', fillBg);
				function fillBg()
				{
					imgBg.style.height = (document.documentElement.clientHeight + 100) + 'px';
				}
				
				//Определяем долю от размера экрана, которую будет занимать увеличенное изображение
				let bigImgageScreenFraction;
				if (window.matchMedia('(max-width: 1080px)').matches) //Зашли с мобильного.
				{
					bigImgageScreenFraction = 1.0;
				}
				else //Зашли с компьютера.
				{
					bigImgageScreenFraction = 0.7;
				}
				//Заглушка для картинки. Появляется вместо неё на том месте откуда она увеличилась.
				let placeholder = document.createElement('img');
				let imgCache = new Map();
				document.querySelectorAll('img[src-big]').forEach((img) =>
				{
					img.smallSrc = img.src;
					if (img.complete)
					{
						onFirstLoad();
					}
					else
					{
						img.addEventListener('load', onFirstLoad);
					}
					function onFirstLoad()
					{
						img.removeEventListener('load', onFirstLoad);
						let defaultStyle = `width: ${img.width}px; height: ${img.height}px`; //Устанавливаем фактические размеры маленькой картинки.
						let isGoingToSmall = false;
						function bigImageLoading()
						{
							img.bigSrcStatus = 'loaded';
							imgCache.delete(img.getAttribute('src-big'));
							img.removeEventListener('load', bigImageLoading);
						}
						img.addEventListener('click', () => 
						{
							if (img.isBig) //Картинка большая - уменьшаем
							{
								if (img.bigSrcStatus === 'loading') //Если картинка не загрузилась, то мы ставим старое маленькое изображение в источник.
								{
									img.bigSrcStatus = 'needReload';
									if (!navigator.userAgent.includes('Firefox')) //В Firefox менять источник не нужно, т.к. он не кэширует недозагруженные изображения и одновременно не показывает background у них.
									{
										img.removeEventListener('load', bigImageLoading);
										img.src = img.smallSrc;
										//Для всех браузеров, кроме Firefox, продолжаем загрузку картинки в фоне (когда она маленькая). Если пользователь кликает по разным изображениям, то все эти изображения будут кэшироваться в Map'е imgCache.
										let key = img.getAttribute('src-big');
										if (!imgCache.has(key))
										{
											let auxImg = document.createElement('img');
											auxImg.src = key
											imgCache.set(key, auxImg);
										}
									}
								}
								//Смотрим по каким координатам надо вернуть картинку на место.
								let coords = placeholder.getBoundingClientRect();
								//Устанавливаем для изображения уменьшенный размер.
								//Но position остаётся fixed, т.к. нужно, чтобы при анимации уменьшения не смещались остальные элементы страницы.
								img.style = `${defaultStyle}; position: fixed; left: ${coords.left}px; top: ${coords.top}px`;
								img.isBig = false;
								imgBg.hidden = true;
								//Указываем, что мы собираемся уменьшить картинку.
								//Эта переменная опять станет false, когда завершится анимация уменьшения.
								isGoingToSmall = true;
							}
							else //Картинка маленькая - увеличиваем.
							{
								imgBg.hidden = false;
								img.isBig = true;
								//Перед тем как увеличить картинку вставляем вместо неё заглушку.
								placeholder.hidden = false;
								placeholder.style = `width: ${img.width}px; height: ${img.height}px; background-color: rgb(200, 200, 200)`;
								img.before(placeholder);
								doImageBig(img);
								if (img.bigSrcStatus !== 'loaded') //Проверяем, загружена ли уже полноразмерная картинка.
								{
									//В Firefox не нужно менять источник снова, если он уже был раньше изменён на большую картинку, иначе Firefox начнёт перезагружать картинку.
									if (!(navigator.userAgent.includes('Firefox') && img.bigSrcStatus === 'needReload')) img.src = img.getAttribute('src-big'); //Загружаем большое изображение.
									img.bigSrcStatus = 'loading';
									img.addEventListener('load', bigImageLoading);
								}
							}
						});
						img.addEventListener('transitionend', () =>
						{
							if (isGoingToSmall) //Отследили завершение анимации уменьшения.
							{
								//Вставляем картинку обратно в поток.
								img.style = defaultStyle;
								isGoingToSmall = false;
								//Убираем заглушку.
								placeholder.hidden = true;
							}
						}); 
						//Сохраняем центровку увеличенной картинки при изменении размеров окна браузера.
						window.addEventListener('resize', () => 
						{
							if (img.IsBig) doImageBig(img);
						});
					}
				});
				
				//Эта функция расчитывает размеры увеличенного изображения и центрирует его.
				//Принимает параметр размера маленького изображения (ширина и высота), что вычислить соотношение сторон.
				function doImageBig(img)
				{
					let screenHeight = document.documentElement.clientHeight;
					let screenWidth = document.documentElement.clientWidth;
					let imgWidth = img.width;
					let imgHeight = img.height;
					let bigImgHeight = Math.round(screenHeight * bigImgageScreenFraction);
					let bigImgWidth = Math.round(screenWidth * bigImgageScreenFraction);
					let ratio = imgWidth / imgHeight
					let newWidth = Math.round(bigImgHeight * ratio);
					if (newWidth < bigImgWidth)
					{
						bigImgWidth = newWidth;
					}
					else
					{
						bigImgHeight = Math.round(bigImgWidth / ratio);
					}
					let left = Math.round(0.5 * (screenWidth - bigImgWidth));
					let top = Math.round(0.5 * (screenHeight - bigImgHeight));
					img.style = `width: ${bigImgWidth}px; height: ${bigImgHeight}px; left: ${left}px; top: ${top}px; position: fixed; z-index: 2`;
				}
			})();
		</script>
		{%- endif -%}
	</body>
</html>
