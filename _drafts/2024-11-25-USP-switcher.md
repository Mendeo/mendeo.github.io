---
layout: post
title: "Автоматическое выключение и включение домашнего сервера при перебоях с электричеством"
date: 2024-11-25 17:00:00 +03
modified: 2024-11-25 17:00:00 +03
categories: arduino tcl
tags: [arduino, server, UPS, tcl, raspberry pi, GPIO]
excerpt_separator: <a name="cut"></a>
links_in_new_tab: true
has_scalable_images: true
disqus_page_id: 013343a26RI725I4bg83vAH1Aj35W74NkH766hV23gP0xUg866i4q14hHMWw968m
---
Я очень люблю ардуино и подобные штуки. Но редко когда удаётся по-настоящему что-то такое применить на практике. Ну, потому что, обычно придумать что-то новое и полезное в хозяйстве, чего ещё нет – это очень сложно. А то, что уже придумано и существует проще купить, особенно в век маркетплейсов. Но вот, наконец, настал тот редкий случай, когда получилось сделать простую, но полезную штуку.
У меня есть домашний сервер: git, nextcloud и т.п. Изначально и последние несколько лет он существовал в виде raspberry pi, с подключёнными к ней внешними жёсткими дисками. А ещё иногда случаются небольшие перебои с электричеством. Поэтому первым делом сервер был запитан от ИБП. Но всегда существовала проблема: когда электричество пропадает, то сервер продолжает работать. Мало того, что в этом нет смысла, т.к. без электричества нет и интернета, так ещё, если свет дать не успеют, то ИБП  высаживается в ноль и сервер жёстко завершит свою работу, что однажды привело к тому, что он больше не загрузился. Поэтому требовалось придумать как завершить работу сервера на время отключения электричества. Первая мысль, конечно, это подключить бесперебойник к компьютеру через USB. Но, к сожалению, из этого ничего не вышло. Я провозился пару вечеров, но так и не смог заставить raspberry pi управлять ИБП по USB ни через NUT ни как-то иначе. В итоге настало время хардового решения.
<a name="cut"></a>
Смысл очень простой. Когда электричество отключают, то ардуино подаёт команду серверу. Тот спокойно завершает свою работу, после этого ардуино при помощи сервомашинки нажимает на кнопку на ИБП и тот вырубается. Когда электричество снова появляется, то ардуино снова нажимает на кнопку и малинка включается. Если электричество вернут в процессе отключения сервера, то кнопку потребуется нажать дважды, чтобы снова его включить. Ожидая появления электричества, ардуино будет работать от батареек.
Вроде бы простая идея при разработке в железе требует учесть некоторые нюансы, которые не всегда очевидны. Но в результате появилась следующая схема прибора:

<img alt="Печатная плата" data-src-big="{% link assets/posts/UPS-switcher/circuit.png %}" src="{% link assets/posts/UPS-switcher/circuit_preview.png %}">

